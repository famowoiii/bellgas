<!DOCTYPE html>
<html>
<head>
    <title>Cart Debug</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body style="padding: 20px; font-family: Arial;">
    <h2>Cart Debug Tool</h2>

    <div id="status" style="background: #f0f0f0; padding: 15px; margin: 10px 0;">
        Status: Loading...
    </div>

    <button onclick="checkCart()" style="padding: 10px 15px; margin: 5px;">Check Cart</button>
    <button onclick="addToCart()" style="padding: 10px 15px; margin: 5px;">Add to Cart</button>
    <button onclick="clearCart()" style="padding: 10px 15px; margin: 5px;">Clear Cart</button>

    <div id="output" style="background: white; border: 1px solid #ccc; padding: 15px; margin: 10px 0; min-height: 300px; font-family: monospace; font-size: 12px;"></div>

    <script>
        let output = document.getElementById('output');
        let status = document.getElementById('status');

        function log(msg) {
            console.log(msg);
            output.innerHTML += '<div>' + msg + '</div>';
            output.scrollTop = output.scrollHeight;
        }

        async function checkAuth() {
            try {
                const response = await fetch('/debug-session');
                const data = await response.json();

                if (data.authenticated && data.jwt_token) {
                    status.innerHTML = '‚úÖ Authenticated: ' + data.user_data?.email;
                    window.JWT_TOKEN = data.jwt_token;
                    window.isAuthenticated = true;
                    return true;
                } else {
                    status.innerHTML = '‚ùå Not authenticated. <a href="/quick-login/customer">Login</a>';
                    return false;
                }
            } catch (error) {
                status.innerHTML = '‚ùå Error: ' + error.message;
                return false;
            }
        }

        async function checkCart() {
            log('üîç Checking cart...');

            if (!await checkAuth()) {
                log('‚ùå Not authenticated');
                return;
            }

            try {
                const response = await fetch('/api/cart', {
                    headers: {
                        'Authorization': 'Bearer ' + window.JWT_TOKEN,
                        'Accept': 'application/json'
                    }
                });

                const data = await response.json();
                log('üì¶ Cart Response: ' + JSON.stringify(data, null, 2));

                if (data.data) {
                    const count = data.data.reduce((sum, item) => sum + parseInt(item.quantity), 0);
                    log('üìä Total items: ' + count);
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        }

        async function addToCart() {
            log('‚ûï Adding to cart...');

            if (!await checkAuth()) {
                log('‚ùå Not authenticated');
                return;
            }

            try {
                const response = await fetch('/api/cart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'Authorization': 'Bearer ' + window.JWT_TOKEN
                    },
                    body: JSON.stringify({
                        product_variant_id: 1,
                        quantity: 1,
                        is_preorder: false
                    })
                });

                const data = await response.json();
                log('üì¶ Add Response: ' + JSON.stringify(data, null, 2));

                if (data.success) {
                    log('‚úÖ Successfully added to cart!');
                    // Check cart again
                    setTimeout(checkCart, 500);
                }
            } catch (error) {
                log('‚ùå Error: ' + error.message);
            }
        }

        async function clearCart() {
            log('üóëÔ∏è Clearing cart...');

            // First get cart items
            await checkCart();

            // This is just a log - we would need delete endpoints to actually clear
            log('‚ÑπÔ∏è To clear cart, you would need to delete individual items via DELETE /api/cart/{id}');
        }

        // Initialize
        checkAuth();
    </script>
</body>
</html>